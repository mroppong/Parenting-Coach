<section class="screen onboarding child-profiles">
  <header class="topbar">
    <button class="link" data-nav="onboarding/child-count" data-i18n="nav.back">Back</button>
    <h2 data-i18n="child_profiles.title">Child Profiles</h2>
  </header>

  <div class="card" id="child-profiles-container">
    <!-- Child profile forms will be injected here -->
  </div>

  <div class="pager">
    <button type="submit" class="primary" id="btn-finish" data-i18n="action.finish">Finish</button>
  </div>

  <script>
    (function() {
      const container = document.getElementById('child-profiles-container');
      const finishButton = document.getElementById('btn-finish');
      const numChildren = Number(sessionStorage.getItem('numChildren') || 1);

      for (let i = 1; i <= numChildren; i++) {
        const formHtml = `
          <form class="form child-profile-form" data-child-index="${i}">
            <h3 data-i18n="child_profiles.child_title" data-i18n-options='{ "index": ${i} }'>Child ${i}</h3>
            <div class="group">
              <label for="child-name-${i}" data-i18n="child_profiles.name_label">Child's Name</label>
              <input type="text" id="child-name-${i}" name="child-name" required />
            </div>
            <div class="group">
              <label for="child-age-${i}" data-i18n="child_profiles.age_label">Age</label>
              <input type="number" id="child-age-${i}" name="child-age" min="0" max="18" required />
            </div>
          </form>
        `;
        container.insertAdjacentHTML('beforeend', formHtml);
      }
      
      if (window.i18n) {
        window.i18n.translate(document.body);
      }

      finishButton.addEventListener('click', () => {
        const profiles = [];
        const forms = document.querySelectorAll('.child-profile-form');
        
        forms.forEach(form => {
          const name = form.querySelector('input[name="child-name"]').value;
          const age = form.querySelector('input[name="child-age"]').value;
          profiles.push({ name, age });
        });

        db.collection('child_profiles').add({
          profiles: profiles,
          createdAt: new Date()
        }).then(docRef => {
          console.log("Child profiles written with ID: ", docRef.id);
          window.navigate('chat');
        }).catch(error => {
          console.error("Error adding child profiles: ", error);
        });
      });
    })();
  </script>
</section>
